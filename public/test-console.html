<!DOCTYPE html>
<html>
  <head>
    <title>bullhorn test console</title>
    <style>
      section {
        border: 2px solid Black;
        margin: 1.5em 0;
        padding: 0 0.5em 1em 0.5em;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-2.0.2.js"></script>
    <script>
      var CONSOLE = {};

      function initUserData(event) {
        event.preventDefault();
       
        CONSOLE.userGuid = $("#userGuid").val();
        $.ajax({type: "PUT", 
                url: "/profiles/" + CONSOLE.userGuid,
                contentType: "application/json",
                data: JSON.stringify([{drain: "web", id: "implied", exclusive: true}])
               })
         .done(function() {
                 CONSOLE.initRan = true;
                 alert("user initialized");
               })
         .fail(function(xhr, status) {
                 alert("initializion failed: " + status);
               });
      } // end of initUserData

      function appendToSocketLog(txt) {
        var ts = new Date();
        $("#inboundNotifications").append(ts.toString() + " - " + txt + "\n");
      }

      function connectToBullhorn(event) {
        event.preventDefault();

        if(!CONSOLE.initRan) {
          alert("need to run step 1 first");
          return;
        }

        appendToSocketLog("connecting...");
        var socket = io.connect("/notifications");
        socket.on("connect", function() {
          socket.emit("announce", {user: CONSOLE.userGuid, version: "0.1.0"});
          CONSOLE.connected = true;
          appendToSocketLog("connected");

          socket.on("notification", function(msg) {
             appendToSocketLog(msg);
          });
        }); 
      }

      function sendNotification(event) {
        event.preventDefault();

        if(!CONSOLE.connected) {
          alert("need to run step 1 and 2 first");
          return;
        }

        $.ajax({
                 type: "POST",
                 url: "/notifications",
                 contentType: "application/json",
                 data: JSON.stringify({
                   to: [
                     {type: "user", id: CONSOLE.userGuid}
                   ], 
                   msg: $("#notificationText").val()
                 })
               })
         .fail(function(xhr, status) {
                 alert("Failed to send notification: " + status);
               })
      }

      $(document).ready(function() {
        $("#initUser").on("click", initUserData);
        $("#connect").on("click", connectToBullhorn);
        $("#sendNotification").on("click", sendNotification);
      });
    </script>
  </head>

  <body>
    <h1>bullhorn test console</h1>

    <section>
      <h2>Step 1 - Initialize User Guid</h2>
      <form>
         User Guid: <input type="text" id="userGuid" size="60"/>
         <button id="initUser">Initalize</button>
      </form>
    </section>

    <section>
      <h2>Step 2 - Connect to WebSocket</h2>
      <form>
        <button id="connect">Connect to Bullhorn</button><br/>
        <textarea id="inboundNotifications" rows="10" cols="80" readonly="true"></textarea>
      </form>
    </section>

    <section>
      <h2>Step 3 - Send Notification</h2>
      <form>
        <input type="text" id="notificationText" size="60"/>
        <button id="sendNotification">Send</button>
      </form>
    </section>
  </body>
</html>
